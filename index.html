<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Hunt: 2-Player P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; overflow: hidden; touch-action: none; font-family: 'Courier New', monospace; }
        canvas { display: block; image-rendering: pixelated; }
        .menu { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #0f0; }
        input { font-size: 2rem; width: 160px; text-align: center; background: #111; color: #0f0; border: 2px solid #0f0; padding: 10px; margin: 15px; outline: none; }
        .btn { padding: 15px 40px; font-size: 1.2rem; cursor: pointer; background: #0f0; color: #000; border: none; font-weight: bold; }
        #stats { position: fixed; top: 10px; width: 100%; display: flex; justify-content: space-around; color: white; pointer-events: none; z-index: 10; font-weight: bold; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>

    <div id="menu" class="menu">
        <h1>CYBER-HUNT P2P</h1>
        <input type="number" id="room-code" placeholder="777">
        <div>
            <button class="btn" onclick="init(true)">HOST</button>
            <button class="btn" style="background:#00f2ff" onclick="init(false)">JOIN</button>
        </div>
        <p id="status">Enter 3-digit code & pick Host or Join</p>
    </div>

    <div id="stats" style="display:none">
        <div id="p1-info">HP: [][][]</div>
        <div id="timer">PIXEL HUNT</div>
        <div id="p2-info">HP: [][][]</div>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let peer, conn, isHost;
        
        // Game State
        const world = { width: 800, height: 1200 }; // Virtual coordinates
        const obstacles = [
            {x: 200, y: 300, w: 400, h: 40},
            {x: 100, y: 600, w: 40, h: 300},
            {x: 660, y: 600, w: 40, h: 300}
        ];

        let p1 = { x: 100, y: 100, hp: 3, role: 'survivor', color: '#0f0', vx: 0, vy: 0 };
        let p2 = { x: 700, y: 1100, hp: 3, role: 'killer', color: '#f00', vx: 0, vy: 0 };
        
        // Touch Joystick Logic
        let touchData = { active: false, startX: 0, startY: 0 };

        function init(hostMode) {
            isHost = hostMode;
            const code = document.getElementById('room-code').value;
            if(!code) return alert("Enter a code!");
            
            document.getElementById('status').innerText = "Connecting...";
            peer = new Peer("PIXEL-VAL-" + code);

            peer.on('open', (id) => {
                if(isHost) {
                    document.getElementById('status').innerText = "Waiting for Player 2...";
                } else {
                    conn = peer.connect("PIXEL-VAL-" + code);
                    setupConn();
                }
            });

            peer.on('connection', (c) => { conn = c; setupConn(); });
        }

        function setupConn() {
            conn.on('open', () => {
                document.getElementById('menu').style.display = 'none';
                document.getElementById('stats').style.display = 'flex';
                requestAnimationFrame(loop);
            });
            conn.on('data', (data) => {
                if(isHost) p2 = data; else p1 = data;
                updateHPUI();
            });
        }

        function updateHPUI() {
            document.getElementById('p1-info').innerText = `G: ${"â¤ï¸".repeat(p1.hp)}`;
            document.getElementById('p2-info').innerText = `R: ${p2.role === 'killer' ? 'ðŸ”ª' : 'â¤ï¸'}`;
        }

        // Controls
        window.addEventListener('touchstart', e => {
            touchData.active = true;
            touchData.startX = e.touches[0].clientX;
            touchData.startY = e.touches[0].clientY;
        });

        window.addEventListener('touchmove', e => {
            if(!touchData.active) return;
            const dx = e.touches[0].clientX - touchData.startX;
            const dy = e.touches[0].clientY - touchData.startY;
            const angle = Math.atan2(dy, dx);
            const speed = 7;
            
            const me = isHost ? p1 : p2;
            me.vx = Math.cos(angle) * speed;
            me.vy = Math.sin(angle) * speed;
        });

        window.addEventListener('touchend', () => {
            const me = isHost ? p1 : p2;
            me.vx = 0; me.vy = 0;
            touchData.active = false;
        });

        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + 30 && obj1.x + 30 > obj2.x && obj1.y < obj2.y + 30 && obj1.y + 30 > obj2.y;
        }

        function loop() {
            // Scale Canvas
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const scaleX = canvas.width / world.width;
            const scaleY = canvas.height / world.height;

            const me = isHost ? p1 : p2;
            
            // Movement + Obstacle collision
            let nextX = me.x + me.vx;
            let nextY = me.y + me.vy;
            let blocked = false;
            
            obstacles.forEach(ob => {
                if(nextX < ob.x + ob.w && nextX + 30 > ob.x && nextY < ob.y + ob.h && nextY + 30 > ob.y) blocked = true;
            });

            if(!blocked) {
                me.x = Math.max(0, Math.min(world.width - 30, nextX));
                me.y = Math.max(0, Math.min(world.height - 30, nextY));
            }

            // Killer Logic (Only handled by Host to prevent lag bugs)
            if(isHost && checkCollision(p1, p2)) {
                p1.hp -= 0.05; // Damage over time while touching
                if(p1.hp < 0) { p1.x = 100; p1.y = 100; p1.hp = 3; alert("Killer Caught You!"); }
            }

            if(conn && conn.open) conn.send(me);

            // Draw
            ctx.fillStyle = '#050505';
            ctx.fillRect(0,0,canvas.width, canvas.height);

            ctx.save();
            ctx.scale(scaleX, scaleY);

            // Obstacles
            ctx.fillStyle = '#333';
            obstacles.forEach(ob => ctx.fillRect(ob.x, ob.y, ob.w, ob.h));

            // Characters
            drawPlayer(p1);
            drawPlayer(p2);

            ctx.restore();
            requestAnimationFrame(loop);
        }

        function drawPlayer(p) {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 30, 30); // Body
            ctx.fillStyle = 'white';
            ctx.fillRect(p.x+5, p.y+5, 5, 5); ctx.fillRect(p.x+20, p.y+5, 5, 5); // Eyes
            
            if(p.role === 'killer') {
                ctx.fillStyle = '#eee';
                ctx.fillRect(p.x + 30, p.y + 10, 15, 5); // Knife Blade
                ctx.fillStyle = '#888';
                ctx.fillRect(p.x + 30, p.y + 8, 2, 9); // Knife Handle
            }
        }
    </script>
</body>
</html>
